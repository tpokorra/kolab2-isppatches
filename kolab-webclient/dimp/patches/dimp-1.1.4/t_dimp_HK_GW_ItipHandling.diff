From: Gunnar Wrobel <p@rdus.de>
Subject: [PATCH] t/dimp/HK/GW/ItipHandling

Allow handling iTip messages in dimp.

Signed-off-by: Gunnar Wrobel <p@rdus.de>

---
 imp.php                 |   23 +++++++
 js/DimpBase.js          |   14 ++++
 2 files changed, 108 insertions(+), 27 deletions(-)

diff --git a/imp.php b/imp.php
index f8b9b5c..70264fe 100644
--- a/imp.php
+++ b/imp.php
@@ -710,6 +710,29 @@ case 'SendMDN':
     $imp_ui = new IMP_UI_Message();
     $imp_ui->MDNCheck($ob->header, true);
     break;
+
+case 'iTip':
+    $selection = Util::getPost('selection');
+    $component = Util::getPost('component');
+    $action = str_replace('_', '-', $selection);
+    $_POST['action'] = array($component => $action);
+
+    if (empty($indices)) {
+        break;
+    }
+    $idx_string = _getIdxString($indices);
+
+    /* Parse MIME info and create the body of the message. */
+    require_once IMP_BASE . '/lib/MIME/Contents.php';
+    $imp_contents = &IMP_Contents::singleton($idx_string);
+
+    $cr = !$imp_contents->buildMessage();
+
+    if (is_a($cr, 'PEAR_Error')) {
+        $notification->push($cr, 'horde.error');
+    }
+
+    break;
 }
 
 // Clear the output buffer that we started above, and log any unexpected
diff --git a/js/DimpBase.js b/js/DimpBase.js
index 96cd917..39a728b 100644
--- a/js/DimpBase.js
+++ b/js/DimpBase.js
@@ -1663,6 +1663,20 @@ var DimpBase = {
         nf.setStyle({ height: (document.viewport.getHeight() - nf.cumulativeOffset()[1] - 10) + 'px' });
     },
 
+    itip: function(action, index, folder, component)
+    {
+        var args, vs;
+
+	vs = this.viewport.getViewportSelection().search({ imapuid: { equal: [ index ] }, view: { equal: [ folder ] } });
+	if (!vs.size() && folder != this.folder) {
+	    vs = this.viewport.getViewportSelection(folder).search({ imapuid: { equal: [ index ] } });
+	}
+
+	args = this.viewport.addRequestParams({ selection: action, component: component });
+
+	DimpCore.doAction('iTip', args, DimpCore.toUIDArray(vs));
+    },
+
     /* Flag actions for message list. */
     flag: function(action, index, folder)
     {

