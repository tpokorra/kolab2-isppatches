From: root <Gunnar Wrobel wrobel@pardus.de>
Subject: [PATCH] t/SyncML/HK/GW/DoubleSyncFix

When the uid validity of an IMAP folder changes this confuses the Kolab storage
driver and leads to double entries. The attached patch has been proposed by
Univention and should be applied after some cleanup.

REF: https://issues.kolab.org/issue3238

Signed-off-by: root <Gunnar Wrobel wrobel@pardus.de>

--- a/a/a/lib/Horde/Kolab/Storage/Data.php	2008-10-20 16:27:27.000000000 +0200
+++ a/a/a/lib/Horde/Kolab/Storage/Data.php	2008-10-20 16:38:34.000000000 +0200
@@ -457,6 +457,14 @@ class Kolab_Data {
         $history = &Horde_History::singleton();
 
         $history_id = $app . ':' . $this->_folder->getShareId() . ':' . $object_uid;
+
+        // entries that should be added to the history MUST not
+        // have an existing entry in the history!! otherwise
+        // they are just marked as "modified"
+        if ($action == 'add' && $history->getActionTimestamp($history_id, 'add') == 0) {
+            $action = 'modify';
+        }
+
         $history->log($history_id, array('action' => $action, 'ts' => $mod_ts), true);
     }
 
